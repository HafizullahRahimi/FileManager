@page "/upload"

@using FileManager.Application.Interfaces
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms

@inject IFileService FileService
@inject AuthenticationStateProvider AuthProvider
@attribute [Authorize]

<PageTitle>Upload</PageTitle>

<h3>ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„</h3>

<InputFile OnChange="HandleFileSelected" MaxFileSize="52428800" />
<p>@message</p>

@code {
    private string message = "";
    private const long MaxFileSize = 50 * 1024 * 1024; // 50MB in bytes

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var user = (await AuthProvider.GetAuthenticationStateAsync()).User;
        var file = e.File;
        if (file != null)
        {
            try
            {
                if (file.Size > MaxFileSize)
                {
                    message = $"âŒ Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ù…Ø¬Ø§Ø² Ø§Ø³Øª. Ø­Ø¯Ø§Ú©Ø«Ø± Ø­Ø¬Ù… Ù…Ø¬Ø§Ø²: {MaxFileSize / 1024 / 1024}MB";
                    return;
                }

                using var stream = file.OpenReadStream(MaxFileSize);
                var id = await FileService.UploadAsync(stream, file.Name, user.Identity?.Name ?? "unknown");
                message = $"âœ… ÙØ§ÛŒÙ„ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯ Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡: {id}";
            }
            catch (Exception ex)
            {
                message = $"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„: {ex.Message}";
            }
        }
    }
}